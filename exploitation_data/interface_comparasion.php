<?php
// ======================================================================
// CONFIGURATION ET LECTURE DU CSV (VERSION OPTIMIS√âE EN M√âMOIRE)
// ======================================================================

// 1. D√©finissez le chemin d'acc√®s √† votre fichier CSV
// ATTENTION: Utilisez le chemin absolu ou relatif correct pour votre environnement MAMP
$CSV_FILE_PATH = '/Users/serdarvarol/Desktop/PVL_L3-25_26/Gestion_Projet/gestion_projet_L3_miashs/csv/6M-0K-99K.users.dataset.public.csv';

$column_names = []; // Noms des variables (Header)
$csv_error = null;
$selected_col_a = $_POST['col_a'] ?? '';
$selected_col_b = $_POST['col_b'] ?? '';


// A. Lire l'ENT√äTE pour le formulaire de s√©lection
try {
    if (!file_exists($CSV_FILE_PATH)) {
        throw new Exception("ERREUR: Fichier CSV non trouv√© √† l'emplacement: " . $CSV_FILE_PATH);
    }
    
    if (($handle_header = fopen($CSV_FILE_PATH, "r")) !== FALSE) {
        $header = fgetcsv($handle_header, 1000, ",");
        if ($header) { $column_names = array_map('trim', $header); }
        fclose($handle_header);
    } else {
        throw new Exception("ERREUR: Impossible d'ouvrir le fichier CSV.");
    }
} catch (Exception $e) { $csv_error = $e->getMessage(); }


// ======================================================================
// B. TRAITEMENT DE LA REQU√äTE API (Formulaire Soumis)
// ======================================================================

$analysis_result = null;
$http_code = null;
$curl_error = null;

if ($_SERVER['REQUEST_METHOD'] === 'POST' && $selected_col_a && $selected_col_b && !isset($csv_error)) {
    
    $col_a_index = array_search($selected_col_a, $column_names);
    $col_b_index = array_search($selected_col_b, $column_names);

    if ($col_a_index === FALSE || $col_b_index === FALSE) {
         $csv_error = "ERREUR: Les colonnes s√©lectionn√©es ne correspondent pas aux ent√™tes du fichier.";
    } else {
        
        $data_to_send_api = [
            $selected_col_a => [],
            $selected_col_b => []
        ];
        
        // 1. Lire SADEEMENT les deux colonnes n√©cessaires
        if (($handle_data = fopen($CSV_FILE_PATH, "r")) !== FALSE) {
            fgetcsv($handle_data, 1000, ","); // Sauter la ligne d'ent√™te

            while (($data = fgetcsv($handle_data, 1000, ",")) !== FALSE) {
                if (isset($data[$col_a_index]) && isset($data[$col_b_index])) {
                    $data_to_send_api[$selected_col_a][] = $data[$col_a_index];
                    $data_to_send_api[$selected_col_b][] = $data[$col_b_index];
                }
            }
            fclose($handle_data);
            
            // 2. Nettoyage des donn√©es (Conversion des types pour Python)
            foreach ($data_to_send_api as $col_name => &$values) {
                foreach ($values as $index => &$value) {
                    if (is_string($value) && trim($value) === '') { $value = null; }
                    if (is_numeric($value)) { $value = (float) $value; }
                }
            }
            unset($value); unset($values);
            
            // 3. Pr√©paration finale de la requ√™te API
            $data_to_send = [
                "col_a_name" => $selected_col_a,
                "col_b_name" => $selected_col_b,
                "data" => $data_to_send_api 
            ];

            $FLASK_API_URL = 'http://127.0.0.1:5000/api/analyze'; 
            $json_data = json_encode($data_to_send);

            // 4. Ex√©cution cURL
            $ch = curl_init($FLASK_API_URL);
            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
            curl_setopt($ch, CURLOPT_POSTFIELDS, $json_data); 
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json', 'Content-Length: ' . strlen($json_data)]);

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            $curl_error = curl_error($ch);
            curl_close($ch);
            
            // 5. Traitement de la r√©ponse
            if ($http_code === 200) { $analysis_result = json_decode($response, true); }

        } else { $csv_error = "ERREUR: Probl√®me de lecture lors de l'ouverture des donn√©es CSV."; }
    }
}
?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>S√©lecteur de Variables et Analyse API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { border: 1px solid #4CAF50; padding: 15px; background-color: #e6ffe6; }
        .error { border: 1px solid #f44336; padding: 15px; background-color: #ffe6e6; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px;}
        select { padding: 8px; width: 300px; }
        img { max-width: 100%; height: auto; border: 1px solid #ccc; margin-top: 20px;}
    </style>
</head>
<body>

    <h1>üß† Analyse de Comparaison des Variables</h1>
    
    <?php if (isset($csv_error)): ?>
        <div class="error">
            <h2>üö® ERREUR DE FICHIER CSV</h2>
            <p><?php echo htmlspecialchars($csv_error); ?></p>
            <p>Veuillez v√©rifier le chemin d'acc√®s du fichier dans le code PHP.</p>
        </div>
    <?php else: ?>
        
        <h2>1. S√©lectionner les Variables du CSV</h2>
        <form method="POST">
            <div class="form-group">
                <label for="col_a">Variable A :</label>
                <select name="col_a" id="col_a" required>
                    <option value="">-- Choisir une colonne --</option>
                    <?php foreach ($column_names as $name): ?>
                        <option value="<?php echo htmlspecialchars($name); ?>" <?php echo ($selected_col_a === $name) ? 'selected' : ''; ?>>
                            <?php echo htmlspecialchars($name); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <div class="form-group">
                <label for="col_b">Variable B :</label>
                <select name="col_b" id="col_b" required>
                    <option value="">-- Choisir une colonne --</option>
                    <?php foreach ($column_names as $name): ?>
                        <option value="<?php echo htmlspecialchars($name); ?>" <?php echo ($selected_col_b === $name) ? 'selected' : ''; ?>>
                            <?php echo htmlspecialchars($name); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <button type="submit">Lancer l'Analyse Python</button>
        </form>

        <hr>

        <h2>2. R√©sultat de l'API Flask</h2>

        <?php if ($analysis_result): ?>
            <div class="success">
                <h3>‚úÖ ANALYSE R√âUSSIE (Variables: <?php echo $selected_col_a; ?> vs <?php echo $selected_col_b; ?>)</h3>
                <p>Statut: <strong><?php echo $analysis_result['Statut']; ?></strong></p>
                
                <h4>üß† Analyse et Visualisation Sugg√©r√©es</h4>
                <ul>
                    <li>**Analyse Recommand√©e:** <?php echo $analysis_result['Analyse_Suggeree']; ?></li>
                    <li>**Visualisation Recommand√©e:** <?php echo $analysis_result['Visualisation_Suggeree']; ?></li>
                </ul>
                
                <?php if (isset($analysis_result['Resultats_Analytiques'])): ?>
                    <h4>üî¢ R√©sultats Analytiques</h4>
                    <ul>
                        <?php foreach ($analysis_result['Resultats_Analytiques'] as $key => $value): ?>
                            <li><strong><?php echo htmlspecialchars($key); ?>:</strong> <?php echo htmlspecialchars($value); ?></li>
                        <?php endforeach; ?>
                    </ul>

                    <?php if (isset($analysis_result['Resultats_Analytiques']['Graphique_Fichier'])): 
                        $graph_file = $analysis_result['Resultats_Analytiques']['Graphique_Fichier'];
                        // ATTENTION: Le chemin doit √™tre accessible par MAMP depuis la page PHP
                        // Ici, nous supposons que le graphique est g√©n√©r√© dans le m√™me r√©pertoire
                        $graph_url = $graph_file; 
                    ?>
                        <h4>üñºÔ∏è Visualisation du Graphique</h4>
                        <img src="<?php echo htmlspecialchars($graph_url); ?>" alt="Graphique Statistique">
                        <p style="font-size: small; color: #666;">Fichier image g√©n√©r√©: <?php echo htmlspecialchars($graph_file); ?></p>
                    <?php endif; ?>

                <?php endif; ?>
                
                <?php if (isset($analysis_result['Avertissement_Suppl']) && is_array($analysis_result['Avertissement_Suppl'])): ?>
                    <h4>‚ö†Ô∏è Avertissements/Notes</h4>
                    <ul>
                        <?php foreach ($analysis_result['Avertissement_Suppl'] as $avertissement): ?>
                            <li class="warning"><?php echo $avertissement; ?></li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>
            </div>
        <?php elseif ($_SERVER['REQUEST_METHOD'] === 'POST'): ?>
            <div class="error">
                <h3>‚ùå ERREUR LORS DE L'APPEL API</h3>
                <?php if ($curl_error): ?>
                    <p>üö® **Erreur cURL:** L'API Flask n'a pas pu √™tre atteinte. D√©tail: <?php echo htmlspecialchars($curl_error); ?></p>
                <?php else: ?>
                    <p>‚ùå **Erreur HTTP <?php echo $http_code; ?>:** La requ√™te a √©chou√©. Message API: <?php echo json_decode($response, true)['error'] ?? 'Veuillez v√©rifier la console Python pour le d√©tail des erreurs.'; ?></p>
                <?php endif; ?>
            </div>
        <?php else: ?>
            <p>Veuillez s√©lectionner deux variables ci-dessus pour lancer l'analyse.</p>
        <?php endif; ?>
        
    <?php endif; ?>

</body>
</html>