<?php
// ======================================================================
// CONFIGURATION ET CONNEXION √Ä LA BASE DE DONN√âES (MySQL via MAMP)
// ======================================================================

// YENƒ∞: Veritabanƒ± ayarlarƒ±nƒ±zƒ± buraya girin (MAMP varsayƒ±lanlarƒ±)
$DB_HOST = 'localhost'; // Veya 'localhost'
$DB_PORT = '8889'; // MAMP'ƒ±n MySQL portu (genellikle 3306'dƒ±r)
$DB_NAME = 'datamoodbd'; // CSV'yi aktardƒ±ƒüƒ±nƒ±z veritabanƒ±nƒ±n adƒ±
$DB_TABLE = 'analysis_view'; // CSV'yi aktardƒ±ƒüƒ±nƒ±z tablonun adƒ±
$DB_USER = 'root'; // MAMP varsayƒ±lan kullanƒ±cƒ± adƒ±
$DB_PASS = 'root'; // MAMP varsayƒ±lan ≈üifresi





$column_names = []; // Noms des variables (Header)
$db_error = null;
$selected_col_a = $_POST['col_a'] ?? '';
$selected_col_b = $_POST['col_b'] ?? '';
$pdo = null;

// A. Veritabanƒ±na baƒülan ve S√úTUN (Header) isimlerini oku
try {
    // YENƒ∞: PDO ile veritabanƒ± baƒülantƒ±sƒ±
    $dsn = "mysql:host=$DB_HOST;port=$DB_PORT;dbname=$DB_NAME;charset=utf8";
    $pdo = new PDO($dsn, $DB_USER, $DB_PASS);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    $pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);

    // YENƒ∞: Tablodaki s√ºtun isimlerini √ßek (CSV header yerine)
    // Bu y√∂ntem SQL enjeksiyonuna kar≈üƒ± g√ºvenlidir, √ß√ºnk√º veritabanƒ±ndan gelen isimleri kullanƒ±rƒ±z.
    $stmt = $pdo->query("SHOW COLUMNS FROM `$DB_TABLE`");
    $column_names = $stmt->fetchAll(PDO::FETCH_COLUMN);
} catch (PDOException $e) {
    $db_error = "ERREUR DE CONNEXION DB: " . $e->getMessage();
}


// ======================================================================
// B. TRAITEMENT DE LA REQU√äTE API (Formulaire Soumis)
// ======================================================================

$analysis_result = null;
$http_code = null;
$curl_error = null;

// DEƒûƒ∞≈ûTƒ∞: $csv_error yerine $db_error kontrol√º
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $selected_col_a && $selected_col_b && !isset($db_error)) {

    // YENƒ∞: S√ºtun isimlerinin veritabanƒ±nda var olup olmadƒ±ƒüƒ±nƒ± kontrol et (SQL Enjeksiyonu √ñnlemi)
    if (!in_array($selected_col_a, $column_names) || !in_array($selected_col_b, $column_names)) {
        $db_error = "ERREUR: Les colonnes s√©lectionn√©es ne correspondent pas √† la table.";
    } else {

        $data_to_send_api = [
            $selected_col_a => [],
            $selected_col_b => []
        ];

        try {
            // YENƒ∞: CSV okumak yerine veritabanƒ±ndan SADECE gerekli iki s√ºtunu √ßek
            // Bu, CSV'yi satƒ±r satƒ±r okumaktan √áOK DAHA HIZLIDIR.
            // S√ºtun isimleri ($selected_col_a) daha √∂nce $column_names ile doƒürulandƒ±ƒüƒ± i√ßin g√ºvenlidir.
            $sql = "SELECT `$selected_col_a`, `$selected_col_b` FROM `$DB_TABLE`";
            $stmt = $pdo->query($sql);

            // YENƒ∞: Verileri API formatƒ±na d√∂n√º≈üt√ºr
            while ($row = $stmt->fetch()) {
                $data_to_send_api[$selected_col_a][] = $row[$selected_col_a];
                $data_to_send_api[$selected_col_b][] = $row[$selected_col_b];
            }

            // 2. Nettoyage des donn√©es (Conversion des types pour Python)
            // DEƒûƒ∞≈ûTƒ∞: Bu b√∂l√ºm aynƒ± kaldƒ±, ancak artƒ±k DB'den gelen veriyi temizliyor.
            // PDO genellikle doƒüru tipleri (√∂rn. NULL) d√∂nd√ºr√ºr, ancak emin olmak iyidir.
            foreach ($data_to_send_api as $col_name => &$values) {
                foreach ($values as $index => &$value) {
                    if (is_string($value) && trim($value) === '') {
                        $value = null;
                    }
                    // PDO zaten sayƒ±larƒ± sayƒ± olarak d√∂nd√ºrmelidir, ancak bu kontrol kalabilir.
                    if (is_numeric($value)) {
                        $value = (float) $value;
                    }
                }
            }
            unset($value);
            unset($values);

            // 3. Pr√©paration finale de la requ√™te API (Bu b√∂l√ºm AYNI KALDI)
            $data_to_send = [
                "col_a_name" => $selected_col_a,
                "col_b_name" => $selected_col_b,
                "data" => $data_to_send_api
            ];

            $FLASK_API_URL = 'http://127.0.0.1:5000/api/analyze';
            $json_data = json_encode($data_to_send);

            // 4. Ex√©cution cURL (Bu b√∂l√ºm AYNI KALDI)
            $ch = curl_init($FLASK_API_URL);
            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
            curl_setopt($ch, CURLOPT_POSTFIELDS, $json_data);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json', 'Content-Length: ' . strlen($json_data)]);

            $response = curl_exec($ch);
            $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            $curl_error = curl_error($ch);
            curl_close($ch);

            // 5. Traitement de la r√©ponse (Bu b√∂l√ºm AYNI KALDI)
            if ($http_code === 200) {
                $analysis_result = json_decode($response, true);
            }
        } catch (PDOException $e) {
            $db_error = "ERREUR D'EX√âCUTION DE REQU√äTE: " . $e->getMessage();
        }
    }
}
?>

<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>S√©lecteur de Variables et Analyse API (Version DB)</title>

    <style>
        /* Genel Stil ve Font */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f9fafb;
            /* A√ßƒ±k gri arkaplan */
            color: #333;
            line-height: 1.6;
            padding: 40px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        h1 {
            color: #6B3FB8;
            /* Marka Rengi */
            font-size: 28px;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        h2 {
            color: #1f2937;
            font-size: 22px;
            margin-top: 30px;
            margin-bottom: 20px;
        }

        hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 30px 0;
        }

        /* Form Stilleri */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
            font-size: 15px;
        }

        select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            appearance: none;
            /* Varsayƒ±lan ok simgesini kaldƒ±r */
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #6B3FB8;
            box-shadow: 0 0 0 3px rgba(107, 63, 184, 0.1);
        }

        button[type="submit"] {
            padding: 12px 25px;
            background: #6B3FB8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        button[type="submit"]:hover {
            background: #7c3aed;
            transform: translateY(-1px);
        }

        /* Mesaj ve Sonu√ß Stilleri */
        .success,
        .error {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 15px;
        }

        .success {
            background-color: #dcfce7;
            /* A√ßƒ±k ye≈üil */
            border: 1px solid #86efac;
            color: #166534;
        }

        .error {
            background-color: #fee2e2;
            /* A√ßƒ±k kƒ±rmƒ±zƒ± */
            border: 1px solid #fca5a5;
            color: #991b1b;
        }

        .success h3,
        .error h2 {
            margin-top: 0;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .success strong,
        .error strong {
            color: #6B3FB8;
        }

        /* Analiz Sonu√ß Listesi */
        .success ul {
            list-style-type: none;
            padding-left: 0;
            margin-top: 15px;
        }

        .success ul li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
            font-size: 14px;
            color: #4b5563;
        }

        .success ul li::before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #6B3FB8;
            font-weight: bold;
        }

        .success h4 {
            color: #1f2937;
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 1px dashed #e5e7eb;
            padding-bottom: 5px;
        }

        /* Grafik G√∂r√ºn√ºm√º */
        img {
            border: 5px solid #e5e7eb;
            /* Beyaz/a√ßƒ±k gri √ßer√ßeve */
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            max-width: 99%;
        }

        /* Uyarƒ± Stili */
        .warning {
            color: #f59e0b;
            /* Turuncu */
            background: #fef3c7;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }


        /*---------------------------*/
        /* CSS AYNI KALDI */
        /*body { font-family: Arial, sans-serif; margin: 20px; }
        .success { border: 1px solid #4CAF50; padding: 15px; background-color: #e6ffe6; }
        .error { border: 1px solid #f44336; padding: 15px; background-color: #ffe6e6; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px;}
        select { padding: 8px; width: 300px; }
        img { max-width: 100%; height: auto; border: 1px solid #ccc; margin-top: 20px;}
        */
    </style>
</head>

<body>
    <div class="container">
        <h1>Analyse de Comparaison des Variables (Beta)</h1>

        <?php if (isset($db_error)): ?>
            <div class="error">
                <h2>üö® ERREUR DE BASE DE DONN√âES</h2>
                <p><?php echo htmlspecialchars($db_error); ?></p>
                <p>Veuillez v√©rifier les param√®tres de connexion DB (host, port, db_name, user, pass) dans le code PHP et que la table '<?php echo $DB_TABLE; ?>' existe.</p>
            </div>
        <?php else: ?>

            <h2>1. S√©lectionner les Variables de la Table '<?php echo $DB_TABLE; ?>'</h2>
            <form method="POST">
                <div class="form-group">
                    <label for="col_a">Variable A :</label>
                    <select name="col_a" id="col_a" required>
                        <option value="">-- Choisir une colonne --</option>
                        <?php foreach ($column_names as $name): ?>
                            <option value="<?php echo htmlspecialchars($name); ?>" <?php echo ($selected_col_a === $name) ? 'selected' : ''; ?>>
                                <?php echo htmlspecialchars($name); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <div class="form-group">
                    <label for="col_b">Variable B :</label>
                    <select name="col_b" id="col_b" required>
                        <option value="">-- Choisir une colonne --</option>
                        <?php foreach ($column_names as $name): ?>
                            <option value="<?php echo htmlspecialchars($name); ?>" <?php echo ($selected_col_b === $name) ? 'selected' : ''; ?>>
                                <?php echo htmlspecialchars($name); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <button type="submit">Lancer l'Analyse Statistique</button>
            </form>

            <hr>

            <h2>2. R√©sultat de Analyse </h2>

            <?php if ($analysis_result): ?>
                <div class="success">
                    <h3>‚úÖ ANALYSE R√âUSSIE (Variables: <?php echo $selected_col_a; ?> vs <?php echo $selected_col_b; ?>)</h3>
                    <p>Statut: <strong><?php echo $analysis_result['Statut']; ?></strong></p>

                    <h4>üß† Analyse et Visualisation Sugg√©r√©es</h4>
                    <ul>
                        <li>**Analyse Recommand√©e:** <?php echo $analysis_result['Analyse_Suggeree']; ?></li>
                        <li>**Visualisation Recommand√©e:** <?php echo $analysis_result['Visualisation_Suggeree']; ?></li>
                    </ul>

                    <?php if (isset($analysis_result['Resultats_Analytiques'])): ?>
                        <h4>üî¢ R√©sultats Analytiques</h4>
                        <ul>
                            <?php foreach ($analysis_result['Resultats_Analytiques'] as $key => $value): ?>
                                <li><strong><?php echo htmlspecialchars($key); ?>:</strong> <?php echo htmlspecialchars($value); ?></li>
                            <?php endforeach; ?>
                        </ul>

                        <?php if (isset($analysis_result['Resultats_Analytiques']['Graphique_Fichier'])):
                            $graph_file = $analysis_result['Resultats_Analytiques']['Graphique_Fichier'];
                            $graph_url = $graph_file;
                        ?>
                            <h4>üñºÔ∏è Visualisation du Graphique</h4>
                            <img src="<?php echo htmlspecialchars($graph_url); ?>" alt="Graphique Statistique">
                            <p style="font-size: small; color: #666;">Fichier image g√©n√©r√©: <?php echo htmlspecialchars($graph_file); ?></p>
                        <?php endif; ?>

                    <?php endif; ?>

                    <?php if (isset($analysis_result['Avertissement_Suppl']) && is_array($analysis_result['Avertissement_Suppl'])): ?>
                        <h4>‚ö†Ô∏è Avertissements/Notes</h4>
                        <ul>
                            <?php foreach ($analysis_result['Avertissement_Suppl'] as $avertissement): ?>
                                <li class="warning"><?php echo $avertissement; ?></li>
                            <?php endforeach; ?>
                        </ul>
                    <?php endif; ?>
                </div>
            <?php elseif ($_SERVER['REQUEST_METHOD'] === 'POST'): ?>
                <div class="error">
                    <h3>‚ùå ERREUR LORS DE L'APPEL API</h3>
                    <?php if ($curl_error): ?>
                        <p>üö® **Erreur cURL:** L'API Flask n'a pas pu √™tre atteinte. D√©tail: <?php echo htmlspecialchars($curl_error); ?></p>
                    <?php else: ?>
                        <p>‚ùå **Erreur HTTP <?php echo $http_code; ?>:** La requ√™te a √©chou√©. Message API: <?php echo json_decode($response, true)['error'] ?? 'Veuillez v√©rifier la console Python pour le d√©tail des erreurs.'; ?></p>
                    <?php endif; ?>
                </div>
            <?php else: ?>
                <p>Veuillez s√©lectionner deux variables ci-dessus pour lancer l'analyse.</p>
            <?php endif; ?>

        <?php endif; ?>
    </div>
</body>

</html>